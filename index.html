<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>BE3dARt</title>
    <meta name="description" content="The HTML5 Herald">
    <meta name="author" content="BE3dARt">

    <link rel="stylesheet" href="css/styles.css">

</head>

<body>

    <div id="page-wrapper">


        <div class="row">
            <div class="column">
                <div>
                    <img src="img/warThunder_Icon.png" alt="War Thunder Icon" width="100" height="100" onclick="window.location.href='index.html'">

                </div>

                <div>

                    <img src="img/UAV_Icon.png" alt="UAV Icon" width="100" height="100" onclick="window.location.href='http://[2a02:aa15:337f:9d00:97b5:b12f:1eb4:a93a]:80/UAVenRoute.html'">

                </div>

            </div>

            <div class="column">
                <h1 id="hello">War Thunder Grind Calculator</h1>
                <div>Calculate the remaining grind for your dream vehicle! You will setup your profile and save it locally to access it every day!</div>

                <div id="box">

                    <div>
                        Silverlions:
                        <input type="number" id="silverlions">
                    </div>

                    <div>
                        Research Points:
                        <input type="number" id="researchPoints">
                    </div>

                </div>

                <div id="box">
                    Premium Account?
                    <input type="checkbox" id="premium">
                </div>

                <div id="box">
                    Import Profile:
                    <input type="file" id="fileInput">
                </div>

                <header class="header">
                    <h1>AudioMeter</h1>
                    <hr>
                </header>

                <div class="container">
                    <button onclick="beginDetect()">Push</button>
                    <p>Levelï¼š<span id="audio-value">null</span></p>
                </div>

                <footer class="footer">
                    <hr>
                    <p><span class="font-c-light">BY</span> Huooo <span class="font-c-light">AT</span> 2018-08-16 10:30:00</p>
                </footer>

                <pre id="fileDisplayArea"></pre>
            </div>


        </div>

    </div>


    <script>
        var audioContext;
        var mediaStreamSource = null
        var meter = null

        function beginDetect() {
            audioContext = new(window.AudioContext || window.webkitAudioContext)()
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    audio: true
                }).then((stream) => {
                    mediaStreamSource = audioContext.createMediaStreamSource(stream)
                    meter = createAudioMeter(audioContext)
                    mediaStreamSource.connect(meter)
                })
            }
        }

        function createAudioMeter(audioContext, clipLevel, averaging, clipLag) {
            const processor = audioContext.createScriptProcessor(512)
            processor.onaudioprocess = volumeAudioProcess
            processor.clipping = false
            processor.lastClip = 0
            processor.volume = 0
            processor.clipLevel = clipLevel || 0.98
            processor.averaging = averaging || 0.95
            processor.clipLag = clipLag || 750

            // this will have no effect, since we don't copy the input to the output,
            // but works around a current Chrome bug.
            processor.connect(audioContext.destination)

            processor.checkClipping = function() {
                if (!this.clipping) {
                    return false
                }
                if ((this.lastClip + this.clipLag) < window.performance.now()) {
                    this.clipping = false
                }
                return this.clipping
            }

            processor.shutdown = function() {
                this.disconnect()
                this.onaudioprocess = null
            }

            return processor
        }

        function volumeAudioProcess(event) {
            const buf = event.inputBuffer.getChannelData(0)
            const bufLength = buf.length
            let sum = 0
            let x

            // Do a root-mean-square on the samples: sum up the squares...
            for (var i = 0; i < bufLength; i++) {
                x = buf[i]
                if (Math.abs(x) >= this.clipLevel) {
                    this.clipping = true
                    this.lastClip = window.performance.now()
                }
                sum += x * x
            }

            // ... then take the square root of the sum.
            const rms = Math.sqrt(sum / bufLength)

            // Now smooth this out with the averaging factor applied
            // to the previous sample - take the max here because we
            // want "fast attack, slow release."
            //this.volume = Math.max(rms, this.volume * this.averaging)
            this.volume = rms;
            document.getElementById('audio-value').innerHTML = this.volume
        }
        
        
        
        
        
        
        
        
        
        
        
        

        var fileInput = document.getElementById('fileInput');
        var fileDisplayArea = document.getElementById('fileDisplayArea');
        var hello = document.getElementById('hello');

        hello.addEventListener('click', function() {
            testus();
        });

        function testus() {
            let silverlions = document.getElementById("silverlions").value;
            let researchPoints = document.getElementById("researchPoints").value;
            let premium = document.getElementById("premium").value;
            fileDisplayArea.innerText = silverlions + researchPoints + premium;
        }

        window.onbeforeunload = function() {
            return "";
        };

        window.onload = function() {

            fileInput.addEventListener('change', function(e) {

                var file = fileInput.files[0];
                var reader = new FileReader();

                reader.onload = function(e) {
                    fileDisplayArea.innerText = reader.result;
                }
                reader.readAsText(file);
            });
        }

    </script>

</body>

</html>
